---
title:  Makefile生成
tags: Linux
pageview: true
layout: article
license: ture
toc: ture
key: a20220909
header:
  theme: dark
  background: 'linear-gradient(135deg, rgb(21, 81, 138), rgb(147, 15, 139))'
aside:
    toc: true
sitemap: true
mathjax: true
abstract: 
author: 转载
---
<a href="https://www.cnblogs.com/jeakeven/p/5546614.html">转载自：https://www.cnblogs.com/jeakeven/p/5546614.html</a>


<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<div>
<h1><span style="color: rgba(0, 128, 0, 1)">Autoconf和Automake使用</span><button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h1>
<p>　　</p>
<h2 id="N10093"><span style="color: rgba(0, 128, 128, 1)">一、生成Makefile流程图</span><button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<p><img src="/assets/makefile.png" alt="" class="medium-zoom-image"></p>
<p>&nbsp;</p>
<h2 id="N10094"><span style="color: rgba(0, 128, 128, 1)">二、具体实例</span><button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<p>　　执行命令顺序：autoscan;&nbsp;aclocal; autoconf; autoheader;&nbsp;automake --add-missing; ./configure; make; ./helloworld;</p>
<h3>1、建目录<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　在你的工作目录下建一个helloworld目录，用来存放helloworld程序及相关文件，如在/home/my/build下：</p>
<div class="cnblogs_code">
<pre><span style="">$ mkdir helloword
$ cd helloworld</span></pre>
</div>
<p>&nbsp;</p>
<h3>2、&nbsp;helloworld.c<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　编辑文件，完成后保存退出。现在在helloworld目录下就应该有一个你自己写的helloworld.c了。</p>
<div class="cnblogs_code">
<pre>　　<span style="color: rgba(0, 0, 255, 1)">int</span> main(<span style="color: rgba(0, 0, 255, 1)">int</span> argc, <span style="color: rgba(0, 0, 255, 1)">char</span>**<span style=""> argv)
　　{
        　　printf(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Hello, Linux World! </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="">);
        　　</span><span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(128, 0, 128, 1)">0</span><span style="">;
　　} </span></pre>
</div>
<p>&nbsp;</p>
<h3>3、生成configure<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<div class="cnblogs_code">
<pre><span style="">　　$ autoscan
　　$ ls
　　configure.scan helloworld.c </span></pre>
</div>
<p>执行后在hellowrold目录下会生成一个文件：configure.scan，可以拿它作为configure.ac的蓝本。</p>
</div>
<div>&nbsp;</div>
<h3>4、生成configure.ac<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<div>
<div>　&nbsp; 现在将configure.scan改名为configure.ac，并且编辑它，按下面的内容修改，去掉无关的语句：</div>
<div>
<div class="cnblogs_code">
<pre>   #                                               -*- Autoconf -*-<span style="">
   # Process </span><span style="color: rgba(0, 0, 255, 1)">this</span><span style=""> file with autoconf to produce a configure script.
  
   AC_PREREQ([</span><span style="color: rgba(128, 0, 128, 1)">2.69</span><span style="">])
   #AC_INIT([FULL</span>-PACKAGE-NAME], [VERSION], [BUG-REPORT-<span style="">ADDRESS])
   AC_INIT(HelloWorld, </span><span style="color: rgba(128, 0, 128, 1)">1.0</span>, jiangtengfei007@<span style="color: rgba(128, 0, 128, 1)">163</span><span style="">.com)
   <span style="color: rgba(255, 0, 0, 1)">AM_INIT_AUTOMAKE(HelloWorld, </span></span><span style="color: rgba(255, 0, 0, 1)">1.0</span><span style=""><span style="color: rgba(255, 0, 0, 1)">)  #这句话很重要，否则下面aclocal出错</span>
   AC_CONFIG_SRCDIR([HelloWorld.c])
   AC_CONFIG_HEADERS([config.h])
 
   # Checks </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> programs.
   AC_PROG_CC
 
   # Checks </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> libraries.
 
   # Checks </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> header files.
  
   # Checks </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> typedefs, structures, and compiler characteristics.
 
   # Checks </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> library functions.
 
   AC_CONFIG_FILES([Makefile])
   AC_OUTPUT</span></pre>
</div>
<p>&nbsp;</p>
</div>
<h3>5、执行aclocal和autoconf<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　然后执行命令aclocal和autoconf，分别会产生aclocal.m4及configure两个文件：</p>
<div class="cnblogs_code">
<pre><span style="">　　$ aclocal
　　$ls
　　<span style="color: rgba(255, 0, 0, 1)">aclocal.m4</span> configure.ac helloworld.c
　　$ autoconf
　　$ ls
　</span><span style="">　aclocal.m4</span><span style=""> autom4te.cache <span style="color: rgba(255, 0, 0, 1)">configure</span> configure.ac helloworld.c </span></pre>
</div>
<p>　　可以看到configure.ac内容是一些宏定义，这些宏经autoconf处理后会变成检查系统特性、环境变量、软件必须的参数的shell脚本。</p>
<p>　　autoconf&nbsp;是用来生成自动配置软件源代码脚本（configure）的工具。configure脚本能独立于autoconf运行，且在运行的过程中，不需要用户的干预。</p>
<p>　　要生成configure文件，你必须告诉autoconf如何找到你所用的宏。方式是使用aclocal程序来生成你的aclocal.m4。</p>
<p>　　aclocal根据configure.ac文件的内容，自动生成aclocal.m4文件。aclocal是一个perl&nbsp;脚本程序，它的定义是：“aclocal - create aclocal.m4 by scanning configure.ac”。</p>
<p>　　autoconf从configure.ac这个列举编译软件时所需要各种参数的模板文件中创建configure。</p>
<p>　　autoconf需要GNU m4宏处理器来处理aclocal.m4，生成configure脚本。</p>
<p>　　m4是一个宏处理器。将输入拷贝到输出，同时将宏展开。宏可以是内嵌的，也可以是用户定义的。除了可以展开宏，m4还有一些内建的函数，用来引用文件，执行命令，整数运算，文本操作，循环等。m4既可以作为编译器的前端，也可以单独作为一个宏处理器.</p>
</div>
<div>&nbsp;</div>
<div>
<div>
<div>&nbsp;</div>
<h3>6、执行autoheader<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<div>　　在执行automake --add-missing之前执行autoheade,&nbsp;<a rel="noopener">生成config.h.in</a></div>
<div>&nbsp;</div>
</div>
</div>
<div>&nbsp;</div>
<div>
<h3>7、新建Makefile.am<a href="http://makefile.am/" rel="noopener"><br></a><button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<div class="cnblogs_code">
<pre>AUTOMAKE_OPTIONS=<span style="">foreign

bin_PROGRAMS</span>=<span style="">helloworld

helloworld_SOURCES</span>=helloworld.c </pre>
</div>
<p>　　automake会根据你写的Makefile.am来自动生成Makefile.in。Makefile.am中定义的宏和目标,会指导automake生成指定的代码。例如，宏bin_PROGRAMS将导致编译和连接的目标被生成。</p>
</div>
<div>&nbsp;</div>
<div>
<h3>8、运行automake<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<div class="cnblogs_code">
<pre>➜  AutoConf_ automake --add-<span style="">missing
configure.ac:</span><span style="color: rgba(128, 0, 128, 1)">7</span>: warning: AM_INIT_AUTOMAKE: two- and three-<span style="">arguments forms are deprecated.  For more info, see:
configure.ac:</span><span style="color: rgba(128, 0, 128, 1)">7</span>: http:<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">www.gnu.org/software/automake/manual/automake.html#Modernize-AM_005fINIT_005fAUTOMAKE-invocation</span>
configure.ac:<span style="color: rgba(128, 0, 128, 1)">12</span>: installing <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">./compile</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="">
configure.ac:</span><span style="color: rgba(128, 0, 128, 1)">7</span>: installing <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">./install-sh</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="">
configure.ac:</span><span style="color: rgba(128, 0, 128, 1)">7</span>: installing <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">./missing</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="">
Makefile.am: installing </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">./depcomp</span><span style="color: rgba(128, 0, 0, 1)">'</span></pre>
</div>
<p>　　automake会根据Makefile.am文件产生一些文件，包含最重要的Makefile.in。</p>
<p>&nbsp;</p>
<h3>9、执行configure生成Makefile<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<div class="cnblogs_code">
<pre>➜  ./<span style="">configure
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span> a BSD-compatible install... /usr/bin/install -<span style="">c
checking whether build environment </span><span style="color: rgba(0, 0, 255, 1)">is</span><span style=""> sane... yes
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span> a thread-safe mkdir -p... ./install-sh -c -<span style="">d
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> gawk... no
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> mawk... no
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> nawk... no
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> awk... awk
checking whether make sets $(MAKE)... yes
checking whether make supports nested variables... yes
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> gcc... gcc
checking whether the C compiler works... yes
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span> C compiler <span style="color: rgba(0, 0, 255, 1)">default</span> output file name... a.<span style="color: rgba(0, 0, 255, 1)">out</span><span style="">
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> suffix of executables...
checking whether we are cross compiling... no
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span> suffix of <span style="color: rgba(0, 0, 255, 1)">object</span><span style=""> files... o
checking whether we are </span><span style="color: rgba(0, 0, 255, 1)">using</span><span style=""> the GNU C compiler... yes
checking whether gcc accepts </span>-<span style="">g... yes
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> gcc option to accept ISO C89... none needed
checking whether gcc understands </span>-c and -<span style="">o together... yes
checking </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style=""> style of include used by make... GNU
checking dependency style of gcc... gcc3
checking that generated files are newer than configure... done
configure: creating .</span>/<span style="">config.status
config.status: creating Makefile
config.status: creating config.h
config.status: executing depfiles commands<br></span></pre>
<pre>➜  <span>ls&nbsp;-l&nbsp;Makefile<br></span><span>-rw-rw-r--&nbsp;1&nbsp;yutao&nbsp;yutao&nbsp;15035&nbsp;Oct&nbsp;15&nbsp;10:40&nbsp;Makefile&nbsp;</span></pre>
</div>
<p>你可以看到，此时Makefile已经产生出来了。</p>
<p>&nbsp;</p>
<h3>10、使用Makefile编译代码<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<div class="cnblogs_code">
<pre><span style="">➜  make
</span>/Applications/Xcode.app/Contents/Developer/usr/bin/make  all-<span style="">am
gcc </span>-DHAVE_CONFIG_H -I.     -g -O2 -MT helloworld.o -MD -MP -MF .deps/helloworld.Tpo -c -<span style="">o helloworld.o helloworld.c
mv </span>-f .deps/helloworld.Tpo .deps/<span style="">helloworld.Po
gcc  </span>-g -O2   -o helloworld helloworld.o</pre>
</div>
<p>&nbsp;</p>
<h3>11、运行helloworld<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<div class="cnblogs_code">
<pre>➜  ./<span style="">helloworld
Hello World</span>!!!!</pre>
</div>
<p>　　这样helloworld就编译出来了，你如果按上面的步骤来做的话，应该也会很容易地编译出正确的helloworld文件。你还可以试着使用一些其他的make命令，如make clean，make install，make dist，看看它们会给你什么样的效果。感觉如何？自己也能写出这么专业的Makefile，老板一定会对你刮目相看。</p>
<p>&nbsp;</p>
<h2 id="N10095"><span style="color: rgba(0, 128, 128, 1)">三、命令详解<em id="__mceDel">&nbsp;</em></span><button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<h3>1、&nbsp;autoscan<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　autoscan是用来扫描源代码目录生成configure.scan文件的。autoscan可以用目录名做为参数，但如果你不使用参数的话，那么autoscan将认为使用的是当前目录。autoscan将扫描你所指定目录中的源文件，并创建configure.scan文件。</p>
<p>&nbsp;</p>
<h3>2、&nbsp;configure.scan<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　configure.scan包含了系统配置的基本选项，里面都是一些宏定义。我们需要将它改名为configure.ac<a href="http://configure.in/" rel="noopener"><br></a></p>
<p>&nbsp;</p>
<h3>3、&nbsp;aclocal
<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　aclocal是一个perl&nbsp;脚本程序。aclocal根据configure.ac文件的内容，自动生成aclocal.m4文件。aclocal的定义是：“aclocal - create aclocal.m4 by scanning configure.ac”。
</p>
<p>&nbsp;
</p>
<h3>4、&nbsp;autoconf
<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　使用autoconf，根据configure.in和aclocal.m4来产生configure文件。configure是一个脚本，它能设置源程序来适应各种不同的操作系统平台，并且根据不同的系统来产生合适的Makefile，从而可以使你的源代码能在不同的操作系统平台上被编译出来。
</p>
<p>　　configure.ac文件的内容是一些宏，这些宏经过autoconf&nbsp;处理后会变成检查系统特性、环境变量、软件必须的参数的shell脚本。configure.ac文件中的宏的顺序并没有规定，但是你必须在所有宏的最前面和最后面分别加上AC_INIT宏和AC_OUTPUT宏。
</p>
<p>　　在configure.ini中：
</p>
<div class="cnblogs_code">
<pre><span style="">　　#号表示注释，这个宏后面的内容将被忽略。

　　AC_INIT(FILE)　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">这个宏用来检查源代码所在的路径。</span><span style="">
　　AM_INIT_AUTOMAKE(PACKAGE, VERSION)　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">这个宏是必须的，它描述了我们将要生成的软件包的名字及其版本号：PACKAGE是软件包的名字，VERSION是版本号。当你使用make dist命令时，它会给你生成一个类似helloworld-1.0.tar.gz的软件发行包，其中就有对应的软件包的名字和版本号。</span><span style="">
　　AC_PROG_CC　　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">这个宏将检查系统所用的C编译器。</span><span style="">
　　AC_OUTPUT(FILE)　　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">这个宏是我们要输出的Makefile的名字。</span><span style=""><br></span></pre>
</div>
<p><span>　　我们在使用automake时，实际上还需要用到其他的一些宏，但我们可以用aclocal 来帮我们自动产生。执行aclocal后我们会得到aclocal.m4文件。 　　产生了configure.ac和aclocal.m4 两个宏文件后，我们就可以使用autoconf来产生configure文件了。</span></p>
<p>&nbsp;</p>
<h3>5、 Makefile.am<a href="http://makefile.am/" rel="noopener"><br></a><button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　Makefile.am是用来生成Makefile.in的，需要你手工书写。Makefile.am中定义了一些内容：
</p>
<div class="cnblogs_code">
<pre>　　AUTOMAKE_OPTIONS　　<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">在执行automake时，它会检查目录下是否存在标准GNU软件包中应具备的各种文件，例如AUTHORS、ChangeLog、NEWS等文件。我们将其设置成foreign时，automake会改用一般软件包的标准来检查。</span><span style="">
　　bin_PROGRAMS　　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">这个是指定我们所要产生的可执行文件的文件名。如果你要产生多个可执行文件，那么在各个名字间用空格隔开。</span><span style="">
　　helloworld_SOURCES　　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">这个是指定产生“helloworld”时所需要的源代码。如果它用到了多个源文件，那么请使用空格符号将它们隔开。比如需要helloworld.h，helloworld.c那么请写成helloworld_SOURCES= helloworld.h helloworld.c。</span></pre>
</div>
<p>　　如果你在bin_PROGRAMS定义了多个可执行文件，则对应每个可执行文件都要定义相对的filename_SOURCES。</p>
<p>&nbsp;</p>
<h3>6、&nbsp;automake<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　使用automake，根据configure.in和Makefile.am来产生Makefile.in。</p>
<div class="cnblogs_code">
<pre>　　--add-missing  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">定义是“add missing standard files to package”，它会让automake加入一个标准的软件包所必须的一些文件。</span></pre>
</div>
<p>　　用automake产生出来的Makefile.in文件是符合GNU Makefile惯例的，接下来我们只要执行configure这个shell&nbsp;脚本就可以产生合适的&nbsp;Makefile&nbsp;文件了。</p>
<p>　　<br>
</p>
<h3>7、&nbsp;Makefile
<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>　　在符合GNU Makefiel惯例的Makefile中，包含了一些基本的预先定义的操作：
</p>
<div class="cnblogs_code">
<pre>　　make　　    <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">根据Makefile编译源代码，连接，生成目标文件，可执行文件。</span><span style="">
　　make clean　　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">清除上次的make命令所产生的object文件（后缀为“.o”的文件）及可执行文件。</span><span style="">
　　make install　　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">将编译成功的可执行文件安装到系统目录中，一般为/usr/local/bin目录。</span><span style="">
　　make list　　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">产生发布软件包文件（即distribution package）。这个命令会将可执行文件及相关文件打包成一个tar.gz压缩的文件用来作为发布软件的软件包。它会在当前目录下生成一个名字类似“PACKAGE-VERSION.tar.gz”的文件。PACKAGE和VERSION，是我们在configure.ac中定义的AM_INIT_AUTOMAKE(PACKAGE, VERSION)。</span><span style="">
　　make distcheck　　</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">生成发布软件包并对其进行测试检查，以确定发布包的正确性。这个操作将自动把压缩包文件解开，然后执行configure命令，并且执行make，来确认编译不出现错误，最后提示你软件包已经准备好，可以发布了。</span>
　　make distclean　　<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">类似make clean，但同时也将configure生成的文件全部删除掉，包括Makefile。</span></pre>

</div>
<p>&nbsp;</p>
<p>&nbsp;</p>

</div>
<div>&nbsp;</div>
<p>&nbsp;</p>
</div>
